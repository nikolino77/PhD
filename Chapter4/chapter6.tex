\chapter{A model for scintillation counting}

!!! Missing introduction !!!

\section{Signal formation}

!!! Missing discussion on signal formation !!!

\subsection{Scintillation pulse}
It is customary to describe \cite{Hyman1963} the scintillation pulse as a sum of exponentials. The processes introducted in the previous paragraph, focuse the attention on the alst step of recombination, and the subsequent radiative transitions. 
All the processes that characterize electron hole relaxation and particularly thermalization o the pairs, lead to oscillations with respect to the start of the scintillation pulse determining a non zero rise time.
For all the practcal purposes of this work rise time will be modeled by one or more exponential time components $\tau _{r}$. 
For what concerns recombination, the radiative transitions can be described by one ore more exponential decay times $\tau _{d}$.
In the case of LSO:Ce, for example, the transition takes place between the lowest 5d level, which lies just below the condiction band, and two 4f levels, above the valence band. The parity allowed transition accounts for very fast decay times ($sim$ 40 ns).

We can consider, then, the absorption of a $\gamma$ photon at a time $\theta$. 
For many scintillators, we can describe the probability density function for the emission times as the convolution of two exponential functions representing the energy transfer processes and the radiative decay \cite{Shao2006}:
\begin{equation}
p_{t}(t|\theta) = \int _{-\infty}^{\infty} \exp{\left( -\frac{t'}{\tau _{r}}\right) } \exp{\left(-\frac{t-t'}{\tau _{d}}\right) } \theta (t') \theta (t-t') dt'
\end{equation}
In the case different processes contribute to the scintillation pulse via different energy transfer mechanisms, it may be necessary to consider them \cite{Seifert2012}
\begin{equation}
p _{t}(t|\theta) = \begin{cases} 0, & t < \theta \\ \sum _{i} S_{i} \frac{1}{\tau _{d, i} - \tau _{r, i}} \cdot \left[ \exp{\left( -\frac{t-\theta}{\tau _{d,i}}\right)} - \exp{\left( -\frac{t-\theta}{\tau _{r,i}}\right) } \right], & t > \theta \end{cases}
\end{equation}

\subsection{Cerenkov pulse}
A shown in the previous chapter, a non negligible amount of Cerenkov photons can be produced by a low energy $\gamma$ event. This is the case since in order to extract a time stamp for a certain event, we oftern make use of single threshold crossing, that is we mainly rely on the information carried by a single photon. Thus if the number of Cerenkov events is not negligible, photons collected at the very beginning of the pulse can come with a high probability from one of these events.

In order to define a Cerenkov pulse, the Geant4 software was used. THe software package will be fully analyzed in the next chapter. For the sake of simplicity, we consider the time of production of Cerenkov photons that follow a $\gamma$ photo electric interaction in a LSO crystal. The delay is given by the geometry of the experiment, in this case the main interest lies in the width of the distribution.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=8cm]{../Pictures/Chapter_4/cerenkov_time.png}
\end{center}
\caption[Cerenkov production]{Cerenkov production profile in LSO by a 511 KeV photon simulated with the Geant4 software package.}
\label{fig:cer_see}
\end{figure}
In this case, as will be for this chapter, no transit time variation for the photons is considered, so that the distribution of Cerenkov photons modeled is the production one, shown in \ref{fig:cer_see}. 
For most practical purposes, and considering that the time scale of the physical quantity, we can safely consider the Cerenkvo pulse as a Gaussian curve in time, with a $\sigma$ in production of $\sigma =$ 3 ps.
It is important to underline that, while the scintillation yield of a certain crystalline species will depend stringly on the production method (doping concentration, tipe of dopant, etc.), the Cerenkov yield depends essentially on density and index of refraction. This means that the respective intensity of the two photon production phenomena should be scaled accordingly. In this study we relied on scintillation values measured in laboratory (see next chapter for the measurement setup) and Cerenkov values extracted from Geant4 simulations.

\section{The Cramer-Rao lower bound}
In general, the emission times t of the detected N photons can be considered statistically indipendent and identucally distributed (iid).
Most photo detectors can be modeled as ideal photon counters, able to detect a time stamp for every incoming photon, a set $T_{N} = \{ t_{1}, t_{2}, ..., t_{N}|\theta \}$.

In order to account for the smearing introduced by the resolution of the detector on the photon time stamps, it is necessary to define its response $p_{T}$. In particular  it can be modeled by a Gaussian with a variance equal to the single photon time resolution (SPTR) and a mean equal to the transit time $t_{TT}$. The function is truncated at $t=0$ not to allow negative transit times.
\begin{equation}
p_{T} = \frac{1}{\sqrt {2\pi} \sigma _{SPTR}} \exp{\left[-\frac{-(t-t_{TT})^{2}}{2(\sigma _{SPTR})^{2}}\right]}
\end{equation}
The corresponding pdf for the time stamps is then a convolution of the photon emission rate and the smearing of the detector.
\begin{equation}
p_{t_{n}}(t|\theta) = p_{t}(t|\theta)\ast p_{T}(t)= \int _{-\infty}^{\infty}p_{t}(t-x|\theta) \cdot p_{T}(x)dx = \int _{0}^{t-\theta}p_{t}(t-x|\theta) \cdot p_{T}(x)dx
\end{equation}
And the integral gives
\begin{eqnarray}
p_{t_{n}}(t|\theta) &=& A \cdot \sum _{i} \frac{S_{i}}{\tau _{d,i} - \tau _{r,i}} \cdot \left[ a_{\tau _{d, i}}(t|\theta) - a_{\tau _{r,i}}(t|\theta)\right]\\
&& + B \cdot \exp{\left( -\frac{(t_{TT} + \mu _{cer} - t)^{2}}{2(\sigma _{cer}^{2}+ \sigma _{SPTR}^{2})} \right)}\\
&& \cdot \left[ erf\left( \frac{-t_{TT}\sigma _{cer}^{2} + \mu _{cer} \sigma _{SPTR}^{2} -\sigma _{SPTR} ^{2}t +(t-\mu _{cer})(\sigma _{cer}^{2}+\sigma _{SPTR}^{2})}{\sqrt{2}\sigma _{SPTR}\sigma_{cer}\sqrt{\sigma _{SPTR}^{2}+\sigma_{cer}^{2}}} \right)\\
&& - erf \left( \frac{-t_{TT}\sigma _{cer}^{2} + \mu _{cer} \sigma _{SPTR}^{2} -\sigma _{SPTR} ^{2}t}{\sqrt{2}\sigma _{SPTR}\sigma_{cer}\sqrt{\sigma _{SPTR}^{2}+\sigma_{cer}^{2}}} \right)
\end{eqnarray}
where 
\begin{eqnarray}
a _{\tau}(t|\theta) &=& \frac{1}{2} \exp{\left(\frac{\sigma _{SPTR} ^{2} - 2t\tau +2\theta \tau + 2t_{TT}\tau}{2\tau ^{2}}\right)} \\
&& \cdot \left[ erf\left( \frac{t-\theta -t_{TT} - \frac{\sigma ^{2}_{SPTR}}{\tau}}{\sigma _{SPTR}\sqrt{2}} \right) + erf \left( \frac{t_{TT}+\frac{\sigma ^{2} _{SPTR}}{\tau}}{\sigma _{SPTR}\sqrt{2}} \right)
\end{eqnarray}
$A$ is the normalization for the scintillation curve, B is the normalization for the Cerenkov curve, $\sigma _{cer}$ is the spread of Cerenkov production and $\mu _{cer}$ is the mean of Cerenkov production, that will be considered at $\theta$ (we assume that the scintillation pulse and the Cerenkov pulse start at the same moment).
The bi exponential model used is shown in figure \ref{fig:models}, as well as the modification in the rise time induced by Cerenkov photons and detector smearing.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=6cm]{../Pictures/Chapter_4/model.png}
\includegraphics[width=6cm]{../Pictures/Chapter_4/models.png}
\end{center}
\caption[Model functions]{Bi exponential model used (left) and modification on the rise introduced by Cerenkov photons and detector smering (right)}
\label{fig:models}
\end{figure}

The Fisher Information $I(\theta)$ is defined as
\begin{equation}
I(\theta) = \int _{-\infty} ^{\infty} \left[ \frac{\partial}{\partial \theta} \ln p_{t_{n}}(t|\theta) \right] ^{2} p_{t_{n}}(t|\theta)dt
\end{equation}
Since the samples are iid, the information is additive, so that
\begin{equation}
I(\theta) = N \cdot \int _{-\infty} ^{\infty} \left[ \frac{\partial}{\partial \theta} p_{t_{n}}(t|\theta) \right] ^{2} \frac{1}{p_{t_{n}}(t|\theta)}dt
\end{equation}
The Cramer Rao theorem states that the variance of any unbiased estimator $\hat{\theta}$ of $\theta$ is bounded by the reciprocal of the Fisher information:
\begin{equation}
var(\hat{\theta})\geq \frac{1}{I(\theta)}
\end{equation}
In a PET-like experiment the interest lies in the estimate of the photon time of interaction $\theta$.
Statistically speaking the Cramer Rao theorem gives the intrinsic time resolution limit for any given scintillator with the given parameters.

\newpage

\section{The order statistics}
If it is assumed a specific order in the set of recorder timestamps, it is evident that they are neither independent nor identically distributed. By sorting the elements in $T_{N}$ we can create an ordered set $T_{\bar{N}} = \{ t_{\bar{1}} \leq t_{\bar{2}} \leq ... \leq t_{\bar{N}} \}$. The pdf for the nth-order statistics is given by\cite{Seifert2012}
\begin{equation}
f_{n|N} (t|\theta) = \binom{N}{n} \cdot n \cdot P_{t_{n}}^{n-1}(t|\theta) \cdot \left[ 1-P_{t_{n}}(t|\theta) \right] ^{N-n}\cdot p_{t_{n}} (t|\theta)
\end{equation}
In this case the set is not iid; thus considering an estimator using a unique timestamps, as the case of analog SiPMs, the Fisher information is
\begin{equation}
I_{n}(\theta) = \int _{-\infty} ^{\infty} \left[ \frac{\partial}{\partial \theta} \ln f_{n}(t|\theta) \right] ^{2} f_{n}(t|\theta)dt
\end{equation}
   
\section{Intrinsic time resolution}

We can now use the frawework expanded in the previous section to infer the timing properties of a simplified setup characterized by five parameters:
\begin{itemize}
\item the light yield
\item the Cerenkov yield
\item the rise time
\item the decay time
\item the spread in Cerenkov emission 
\end{itemize}
Thanks to the Cramer-Rao theorem it is possible to extract the lower bound in coincidence time resolution for a setup with specified parameters. This means that the entire set is used in the statistics, regardless of the method used to extract the time information: this represents a theoretical value given the information contained in the set.
It is important to stress that for the moment we do not consider any spread introduced by the trasnport of photons inside the volume. This will be considered in the next chapter, where Monte-Carlo simulations will allow to introduce this additional parameter.

In order to weight the importance of the various model parameters in the calculation of the time resolution of the system, we first make use of the entire statistical set, that is we find the lower bound.
In a first moment the Cerenkov yield is set to zero.
This is the case for crystals with very low collection efficiency or very low Cerenkov production. In the case of samples used in this study this number can be estimated to range between 2 and 10 depending on the crystal and the wrapping condition. 

The first consequence of assuming iid samples is that the information is proportional to the number of photons collected.
This implies inverse proportionality for the lower limit on the variance. If we assume a light yield of 5000 photons/MeV, which is shown in the next chapter to be a good approximation for LSO crystals, we can focuse on the time dependence of the model.

!! Cramer-Rao plots missing !!

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=6cm]{../Pictures/Chapter_4/rise_CTRpng}
%\includegraphics[width=6cm]{../Pictures/Chapter_4/sigma_CTR.png}
\end{center}
\caption[Cramer Rao evolution - rise time]{Cramer Rao lower bound as a function of rise time for different values of decay times (left) and SPTR (right)}
\label{fig:cramer_rise}
\end{figure}
%In figure \ref{fig:} and \ref{fig:} is shown the dependance of the CTR from the time profiles of the crystals,
%and the SPTR.
%Imrp

The role of Cerenkov photons becomes somehow more obscure in this situation. As shown in figure \ref{fig:cramer_cer}, a small number of Cerenkov photons collected can in principle worsen the lower bound achievable. This is due to the fact that the fast emission can introduce a higher variance when combined to the bi exponential statistics. This is strongly correlated with the light yield of the crystal measured, since this effect is more and more pronounced as the light yield grows. Indeed when the scintillation photons produced are a few, we start relying mainly on Cerenkov photons. This simply states that a device which could make use of Cerenkov photons in significative number would reach a better value for time resolution since it would not depend on the time profile of the scintillation.
% that is from rise time and decay time. The SPTR value is set to 70 ps, which is a value consistent to the SiPMs used in this work and can deliver the top performance in terms of time resolution.
%The decay time is shown to influence the time resolution more importantly. Indeed decreasing the decay time 
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=8cm]{../Pictures/Chapter_4/CY_LY_cramer_rao.png}
%\includegraphics[width=6cm]{../Pictures/Chapter_4/sigma_CTR.png}
\end{center}
\caption[Cramer Rao evolution - Cerenkov]{Cramer Rao lower bound as a function of Cerenkov photons collected}
\label{fig:cramer_cer}
\end{figure}

\section{Effects on signal extraction}

If we consider a time pick up system similar to the one used in this study, it is necessary to extend the anlysis to the order statistics in use. 
It is the case of SiPMs used in PET detectors, as shown in \ref{fig:crossing}, as the signal is a build up of single cells firing. We then basically rely on the information of a threshold passing. An example of this time pick up method will be shown in chapter 7.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=8cm]{../Pictures/Chapter_4/crossing.pdf}
\end{center}
\caption[Threshold crossing example]{Example of a time pickup method based on threshold crossing. It is the method used by the NINO chip used in this work.}
\label{fig:crossing}
\end{figure}
In figure \ref{fig:rank} is shown the time distribution for photon of different rank following the order statistics previously obtained, for the case with SPTR = 0 and SPTR = 70 ps.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=6cm]{../Pictures/Chapter_4/photon_rank.png}
\includegraphics[width=6cm]{../Pictures/Chapter_4/photon_rank_no_smear.png}
\end{center}
\caption[Photon rank RMS]{Time distribution for photon of different rank without (left) and with (right) detector smearing}
\label{fig:rank}
\end{figure}
It is already clear that, in general, it is not the first order statistic that provides the estimation with the lower variance. This is due to the smearing introduced by the detector. Indeed, a non-smeared time profile would entail a monotonous increase of the variance, as shown in figure \ref{}, where the variance of the n-th photon collected is plot, at different parameter values.
In the same plot we can focus on the role of rise time on the shape of the curve. 
Indeed a faster rise time, not only is associated with lower variances for photon of the same rank, as expected, but it slides the order statistics with the smallest variance.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=6cm]{../Pictures/Chapter_4/taur_rank_nosptr.png}
\includegraphics[width=6cm]{../Pictures/Chapter_4/tau_r_rank.png}
\end{center}
\caption[Rank variance - rise time]{The evolution of the variance of the n-th rank photon for different rise time values with SPTR = 0 (left) and SPTR = 70 (right).}
\label{fig:rise_rank}
\end{figure}
As can be seen from a comparison of the variance curves for photons of different rank and lower bounds for the same parameters, a detector which makes us of a single time stamp can not reach the lower bound. Thus the late photons carry some information, which is not used in the methods used in this study. An approach to include this photons in the analysis could make use of digital pick up techniques. 

For what concerns Cerenkov photons, it is shown in figure \ref{fig:} that they have a significative impact only if at least five of them can be collected. Indeed for a very small number of Cerenkov photons the CTR resolution is the same, and so the variance associated with the order statistics with the smallest variance.
Things change when a higher number of Cerenkov photons are collected. In this case the ratio between scintillation photons and Cerenkov photons can be quite small, so that we start to rely mainly on the latter.
This can be the case for crystal such as LuAG or PbWO$_{4}$. As will be shwon in the next chapter, for our purposes the Cerenkov pulse will introduce a modified rise time non negligible when extracting the absolute value.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=8cm]{../Pictures/Chapter_4/CER_photon_rank.png}
\end{center}
\caption[Rank variance - Cerenkov]{The evolution of the variance of the n-th rank photon for different Cerenkov yields.}
\label{fig:rise_rank}
\end{figure}

